{% load custom_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    <title>{{ title }}</title>
</head>
<body>
    <div id="chat-window">
        {% include 'ChatAPI/messages.html' %}
    </div>

    <form method="post" hx-post="{% url 'chat' chat_id=chat_id %}" hx-target="#chat-window" hx-swap="innerHTML">
        {% csrf_token %}
        {% for f in form %}
            <div>
                <label for="{{ f.id_for_label }}">{{ f.label }}:</label>
                {{ f }}
            </div>
        {% endfor %}
        {% for message in messages %}
            <div{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
        {% endfor %}
        <p><button type="submit">Отправить сообщение</button></p>
    </form>

    <script>
        // Обновление после успешного запроса
        let chatWindow = document.getElementById('chat-window');
        chatWindow.addEventListener('htmx:afterSwap', (event) => {
            // Прокрутка вниз
            chatWindow.scrollTop = chatWindow.scrollHeight;
        });
    </script>

    <script>
        const chatId = '{{ chat_id }}';  // chat_id из контекста
        const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + chatId + '/');

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const sender = data.sender;

            // Добавьте сообщение в чат
            const chatWindow = document.getElementById('chat-window');
            const newMessage = document.createElement('div');
            newMessage.innerText = sender + ": " + message;
            chatWindow.appendChild(newMessage);

            // Прокрутка вниз
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    </script>
</body>
</html>